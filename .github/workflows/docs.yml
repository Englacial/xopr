name: Build and Deploy Jupyter Book

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write  # Added for PR comments

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BASE_URL: /xopr

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install dependencies
      run: |
        uv sync --extra test --extra stac
    
    - name: Install package in development mode
      run: |
        uv pip install -e .
    
    - name: Run tests with pytest
      run: |
        uv run pytest --cov=xopr --cov-report=html --cov-report=xml --cov-report=term
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./htmlcov

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python
      run: uv python install

    - name: Install dependencies
      run: uv sync --extra docs

    - name: Build Jupyter Book
      run: |
        cd docs
        uv run --extra docs jupyter-book build --html --execute 2>&1 | tee jupyter-book-build.log
        # Check for errors running the notebooks and fail if any are found
        if grep -r "Error\\|Exception\\|Traceback" jupyter-book-build.log; then
          echo "Found execution errors in build"
          exit 1
        fi

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: ./coverage-temp

    - name: Copy coverage to docs build
      run: |
        mkdir -p docs/_build/html/coverage
        cp -r ./coverage-temp/* docs/_build/html/coverage/
    
    # Copy map assets for polar map functionality
    - name: Copy map assets
      run: |
        if [ -d "src/xopr/map" ]; then
          echo "Copying map assets from src/xopr/map..."
          mkdir -p docs/_build/html/_static/maps
          cp -f src/xopr/map/polar.html docs/_build/html/_static/maps/ 2>/dev/null || true
          cp -f src/xopr/map/parquet_wasm.js docs/_build/html/_static/maps/ 2>/dev/null || true
          cp -f src/xopr/map/parquet_wasm_bg.wasm docs/_build/html/_static/maps/ 2>/dev/null || true
          cp -f src/xopr/map/*.parquet docs/_build/html/_static/maps/ 2>/dev/null || true
          echo "Map assets copied successfully"
        else
          echo "Warning: src/xopr/map directory not found, skipping map assets"
        fi
    
    # Upload artifact for all builds (PR and main)
    - name: Upload docs artifact
      uses: actions/upload-artifact@v4
      with:
        name: docs-html-${{ github.sha }}
        path: docs/_build/html
        retention-days: 7

    - name: Setup Pages
      uses: actions/configure-pages@v5
      if: github.ref == 'refs/heads/main'

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: docs/_build/html

  # Deploy PR Preview to GitHub Pages branch
  pr-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Download docs artifact
      uses: actions/download-artifact@v4
      with:
        name: docs-html-${{ github.sha }}
        path: ./docs-preview
    
    - name: Deploy to GitHub Pages branch and Surge
      id: deploy_preview
      run: |
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Create or checkout the PR preview branch
        PREVIEW_BRANCH="pr-preview-${{ github.event.pull_request.number }}"
        
        # Save docs-preview to a temp location
        mv ./docs-preview /tmp/docs-preview-backup
        
        # Check if branch exists on remote
        if git ls-remote --heads origin $PREVIEW_BRANCH | grep -q $PREVIEW_BRANCH; then
          echo "Branch $PREVIEW_BRANCH exists, fetching and checking out"
          git fetch origin $PREVIEW_BRANCH:$PREVIEW_BRANCH
          # Clean working directory first, then force checkout
          git clean -fdx
          git checkout -f $PREVIEW_BRANCH
        else
          echo "Creating new orphan branch $PREVIEW_BRANCH"
          git checkout --orphan $PREVIEW_BRANCH
        fi
        
        # Clean the branch
        git rm -rf . 2>/dev/null || true
        
        # Copy the built docs from backup location
        cp -r /tmp/docs-preview-backup/* .
        
        # Add all files
        git add -A
        
        # Commit (allow empty in case nothing changed)
        git commit -m "Deploy PR #${{ github.event.pull_request.number }} preview - commit ${{ github.sha }}" --allow-empty
        
        # Push to GitHub
        git push origin $PREVIEW_BRANCH --force
        
        # Now deploy the same content to Surge with proper structure
        echo "Deploying to Surge.sh..."
        npm install -g surge
        
        # Create deployment structure with /xopr/ subdirectory to match asset paths
        mkdir -p /tmp/surge-deploy/xopr
        cp -r . /tmp/surge-deploy/xopr/
        
        # Create redirect index at root that adds trailing slash
        cat > /tmp/surge-deploy/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <script>
            // Redirect to /xopr/ with trailing slash
            window.location.href = '/xopr/';
          </script>
          <meta http-equiv="refresh" content="0; url=/xopr/">
        </head>
        <body>
          Redirecting to <a href="/xopr/">documentation</a>...
        </body>
        </html>
        EOF
        
        # Create 200.html for Surge SPA support (handles client-side routing)
        # Need 200.html in both root and /xopr/ directory for proper routing
        cp /tmp/surge-deploy/xopr/index.html /tmp/surge-deploy/200.html || true
        cp /tmp/surge-deploy/xopr/index.html /tmp/surge-deploy/xopr/200.html || true
        
        # Deploy with proper structure
        SURGE_DOMAIN="xopr-pr-${{ github.event.pull_request.number }}.surge.sh"
        
        cd /tmp/surge-deploy
        surge . $SURGE_DOMAIN --token ${{ secrets.SURGE_TOKEN }} || {
          echo "::warning::Surge deployment failed"
          echo "surge_url=" >> $GITHUB_OUTPUT
          exit 0
        }
        
        echo "surge_url=https://$SURGE_DOMAIN/xopr/" >> $GITHUB_OUTPUT
        echo "preview_branch=$PREVIEW_BRANCH" >> $GITHUB_OUTPUT
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.issue.number;
          const sha = context.sha.substring(0, 7);
          const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
          const surgeUrl = '${{ steps.deploy_preview.outputs.surge_url }}';
          const previewBranch = '${{ steps.deploy_preview.outputs.preview_branch }}';
          
          let body = `## 📚 Documentation Preview Ready!\n\n`;
          
          // Add Surge preview URL if available
          if (surgeUrl && surgeUrl !== '') {
            body += `### 🌐 Live Preview\n**URL:** ${surgeUrl}\n\n`;
          } else {
            body += `### ⚠️ Surge deployment not available\n`;
            body += `Please check the [workflow logs](${artifactUrl}) or set up SURGE_TOKEN secret.\n\n`;
          }
          
          // Add link to preview branch
          if (previewBranch) {
            body += `### 🌿 Preview Branch\n`;
            body += `Preview content stored in branch: [\`${previewBranch}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/${previewBranch})\n\n`;
          }
          
          body += `### 📦 Download Preview\n`;
          body += `You can download the preview artifact [here](${artifactUrl}) for local viewing.\n\n`;
          body += `**Commit:** \`${sha}\`\n\n`;
          body += `---\n*This preview will be updated automatically with new commits.*`;
          
          // Find and update existing comment or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });
          
          const botComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('Documentation Preview Ready')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4